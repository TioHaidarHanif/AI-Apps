<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>People Counter</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; background:#f6f8fa; margin:0; }
    .wrap { max-width: 780px; margin: 40px auto; background:#fff; padding: 24px; border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    h1 { margin-top: 0; font-size: 22px; }
    .row { display:flex; gap:24px; align-items:flex-start; flex-wrap: wrap; }
    .panel { flex:1; min-width: 280px; }
    .card { background:#fafbfc; border:1px solid #e5e7eb; padding:16px; border-radius:10px; }
    button { padding:10px 16px; border:0; background:#2563eb; color:#fff; border-radius:8px; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .result { margin-top:16px; padding:12px; border-radius:8px; }
    .ok { background:#ecfdf5; border:1px solid #34d399; color:#064e3b; }
    .err { background:#fef2f2; border:1px solid #f87171; color:#7f1d1d; }
    img { max-width:100%; height:auto; border-radius:8px; border:1px solid #e5e7eb; }
    canvas { max-width:100%; height:auto; border-radius:8px; border:1px solid #e5e7eb; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>People Counter</h1>
    <div class="row">
      <div class="panel">
        <div class="card">
          <input id="file" type="file" accept="image/*" />
          <div style="margin-top:12px">
            <button id="btn" disabled>Prediksi</button>
          </div>
          <div id="msg" class="result" style="display:none"></div>
        </div>
      </div>
      <div class="panel">
        <div class="card">
          <div style="display:grid; gap:12px;">
            <img id="preview" alt="preview" style="display:none" />
            <canvas id="canvas" style="display:none"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    const API = 'http://localhost:8100/count';
    const fileEl = document.getElementById('file');
    const btn = document.getElementById('btn');
    const msg = document.getElementById('msg');
    const preview = document.getElementById('preview');
    const canvas = document.getElementById('canvas');

    fileEl.addEventListener('change', () => {
      btn.disabled = !fileEl.files.length;
      if (fileEl.files.length) {
        const url = URL.createObjectURL(fileEl.files[0]);
        preview.src = url; preview.style.display = 'block';
        canvas.style.display = 'none';
      }
    });

    btn.addEventListener('click', async () => {
      if (!fileEl.files.length) return;
      msg.style.display = 'none';
      msg.className = 'result';

      const form = new FormData();
      form.append('file', fileEl.files[0]);

      btn.disabled = true; btn.textContent = 'Memproses...';
      try {
        const res = await fetch(API, { method: 'POST', body: form });
        if (!res.ok) throw new Error('API error: ' + res.status);
        const data = await res.json();

        const count = data.count || 0;
        const boxes = data.boxes || [];
        msg.textContent = count > 0
          ? `Kesimpulan: Terdapat ${count} orang dalam gambar.`
          : 'Kesimpulan: Tidak terdeteksi orang dalam gambar.';
        msg.classList.add('ok');
        msg.style.display = 'block';

        // draw boxes on canvas
        // ensure canvas size = preview size
        await new Promise(r => preview.complete ? r() : preview.onload = r);
        const w = preview.naturalWidth, h = preview.naturalHeight;
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(preview, 0, 0, w, h);
        ctx.lineWidth = Math.max(2, Math.min(w, h) / 300);
        ctx.strokeStyle = '#22c55e';
        ctx.font = `${Math.max(14, Math.min(w, h) / 40)}px sans-serif`;
        ctx.fillStyle = 'rgba(34,197,94,0.2)';
        boxes.forEach(b => {
          const [x1, y1, x2, y2, conf] = b;
          const bw = x2 - x1, bh = y2 - y1;
          ctx.strokeRect(x1, y1, bw, bh);
          ctx.fillRect(x1, y1, bw, bh);
          const label = `person ${(conf*100).toFixed(1)}%`;
          const tw = ctx.measureText(label).width;
          const th = parseInt(ctx.font, 10) + 6;
          ctx.fillStyle = '#22c55e';
          ctx.fillRect(x1, Math.max(0, y1 - th), tw + 8, th);
          ctx.fillStyle = '#fff';
          ctx.fillText(label, x1 + 4, Math.max(12, y1 - 4));
          ctx.fillStyle = 'rgba(34,197,94,0.2)';
        });
        preview.style.display = 'none';
        canvas.style.display = 'block';
      } catch (e) {
        msg.textContent = 'Gagal memproses: ' + e.message;
        msg.classList.add('err');
        msg.style.display = 'block';
      } finally {
        btn.disabled = false; btn.textContent = 'Prediksi';
      }
    });
  </script>
</body>
</html>
